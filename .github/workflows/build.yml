name: Ubuntu Build
on:
  workflow_dispatch:
  push:
    branches: [ main,master ]
    paths:
      - '.github/workflows/build.yml'
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    env:
      DEBIAN_FRONTEND: noninteractive
      TZ: Asia/Shanghai
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
          sudo \
          openjdk-11-jdk \
          libx11-6 \
          libxcomposite1 \
          libxrandr2 \
          libxss1 \
          libgdk-pixbuf2.0-0 \
          libgtk-3-0 \
          xauth \
          libbz2-dev \
          libncurses5-dev \
          libffi-dev \
          libreadline-dev \
          libssl-dev \
          zlib1g-dev \
          build-essential \
          libsqlite3-dev \
          tk-dev \
          libgdbm-dev \
          libc6-dev \
          liblzma-dev \
          libncursesw5-dev \
          git \
          python3-pip \
          python-is-python3 \
          python3-venv \
          wget \
          unzip \
          && apt-get clean \
          && rm -rf /var/lib/apt/lists/*

      - name: Install pyenv and Python and Install Env and Build Executable
        shell: bash -l {0}
        run: |
          wget https://bj.bcebos.com/petite-mark/public_read/vipshop/Jetbrains/pyenv-2.5.0.zip -O pyenv.zip && unzip pyenv.zip && mv pyenv-2.5.0/ ~/.pyenv && rm pyenv.zip
          
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
          echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
          
          # ç«‹å³ç”Ÿæ•ˆ
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init --path)"
          
          mkdir -p ~/.pyenv/cache && wget https://bj.bcebos.com/petite-mark/public_read/vipshop/Jetbrains/Python-3.9.9.tar.xz -O ~/.pyenv/cache/Python-3.9.9.tar.xz
          ln -s ~/.pyenv/bin/pyenv /usr/bin/pyenv && pyenv install 3.9.9 && sudo pyenv global 3.9.9 && rm -rf ~/.pyenv/cache/Python-*.tar.xz
          
          rm -f ~/.pyenv/version
          echo "3.9.9" > ~/.pyenv/version
          pyenv rehash
          
          # éªŒè¯å®‰è£…
          echo "å½“å‰System Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰System Pythonç‰ˆæœ¬: $(python --version)"
          echo "å½“å‰System pipç‰ˆæœ¬: $(pip --version)"
          
          pip install --no-cache-dir uv
          uv venv --python=3.9.9
          source .venv/bin/activate
          
          echo "å½“å‰Pythonè·¯å¾„: $(which python)"
          echo "å½“å‰Pythonç‰ˆæœ¬: $(python --version)"
          echo "å½“å‰pipç‰ˆæœ¬: $(pip --version)"
          
          uv sync
          uv run main.py

      - name: Create summary
        run: |
          echo "### ðŸŽ‰ Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "Python Version: $(python --version)" >> $GITHUB_STEP_SUMMARY
